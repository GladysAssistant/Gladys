version: 2.1

shared: &shared
  docker:
    - image: docker:18.06.3-ce-git
  working_directory: ~/gladys-build
  steps:
    - attach_workspace:
        at: ~/gladys-build-front
    - checkout:
        path: ~/gladys-build
    - setup_remote_docker:
        docker_layer_caching: false
    - run:
        name: Copy build front folder
        command: cp -r ~/gladys-build-front/front/build/. ~/gladys-build/static
    - run:
        name: Show front folder
        command: ls ~/gladys-build/static
    - run:
        name: Install build dependencies.
        command: apk add --no-cache bash curl git jq make perl
    - run:
        name: Add dynamic shared vars to env.
        command: |
          .circleci/load_env.sh
    - run:
        name: Build and push Docker image.
        command: |
          if git log -1 --pretty=%B | grep "^[v]\+[0-9]*\+\.[0-9]*\+\.[0-9]*\+$"; then
            MAJOR_VERSION=$(echo $CIRCLE_TAG | cut -d'.' -f 1)
            VERSION=$CIRCLE_TAG
          fi
          if [[ $CIRCLE_BRANCH = master ]]; then
            VERSION="dev";
          fi
          source $BASH_ENV
          .circleci/build-image.sh
        no_output_timeout: 2h

jobs:
  test-server:
    working_directory: ~/gladys-test
    docker:
      - image: circleci/node:lts
    steps:
      - checkout:
          path: ~/gladys-test
      - run:
          name: Install system dependencies
          command: |
            sudo apt-get install -y libudev-dev sqlite3 openssl openzwave libopenzwave1.5-dev
      - run:
          name: Install global dependencies
          command: 'sudo npm install typescript node-gyp npm@latest -g'
      - restore_cache: # special step to restore the dependency cache
          # Read about caching dependencies: https://circleci.com/docs/2.0/caching/
          key: dependency-cache-{{ checksum "server/package.json" }}-node-lts
      - run:
          name: Install NPM dependencies
          command: cd server && npm install
      - save_cache: # special step to save the dependency cache
          key: dependency-cache-{{ checksum "server/package.json" }}-node-lts
          paths:
            - ./server/node_modules
      - run:
          name: Run prettier
          command: cd server && npm run prettier-check
      - run:
          name: Run eslint
          command: cd server && npm run eslint
      - run:
          name: Tests with coverage
          command: cd server && npm run coverage
      - run:
          name: Push coverage
          command: npm i && npm run push-coverage
  test-front:
    working_directory: ~/gladys-test/front
    docker:
      - image: circleci/node:lts
    steps:
      - checkout:
          path: ~/gladys-test
      - run:
          name: Install global dependencies
          command: 'sudo npm install codecov npm@latest -g'
      - restore_cache: # special step to restore the dependency cache
          # Read about caching dependencies: https://circleci.com/docs/2.0/caching/
          key: dependency-cache-{{ checksum "package.json" }}-node-lts
      - run:
          name: Install NPM dependencies
          command: npm install
      - save_cache: # special step to save the dependency cache
          key: dependency-cache-{{ checksum "package.json" }}-node-lts
          paths:
            - ./node_modules
      - run:
          name: Run prettier
          command: npm run prettier-check
      - run:
          name: Run eslint
          command: npm run eslint
  build-front:
    working_directory: ~/gladys-build
    docker:
      - image: circleci/node:lts
    steps:
      - checkout
      - run:
          name: Build Front
          command: 'cd front && npm install && npm run build'
      - persist_to_workspace:
          root: ~/gladys-build
          paths:
            - front/build
  docker_manifest:
    machine:
      enabled: true
      image: circleci/classic:201808-01
    steps:
      - checkout
      - run:
          name: Add dynamic shared vars to env.
          command: |
            .circleci/load_env.sh
      - run:
          name: Creating manifest for releases tag
          command: |
            # Turn on Experimental features
            sudo mkdir $HOME/.docker
            sudo sh -c 'echo "{ \"experimental\": \"enabled\" }" >> $HOME/.docker/config.json'
            echo $DOCKERHUB_PASS | sudo docker login -u $DOCKERHUB_USER --password-stdin
            if git log -1 --pretty=%B | grep "^[v]\+[0-9]*\+\.[0-9]*\+\.[0-9]*\+$";
            then
              sudo docker manifest create --amend $DOCKERHUB_REPO:$CIRCLE_TAG $DOCKERHUB_REPO:$CIRCLE_TAG-amd64 $DOCKERHUB_REPO:$CIRCLE_TAG-i386 $DOCKERHUB_REPO:$CIRCLE_TAG-arm $DOCKERHUB_REPO:$CIRCLE_TAG-arm32v7 $DOCKERHUB_REPO:$CIRCLE_TAG-arm64v8
              sudo docker manifest annotate $DOCKERHUB_REPO:$CIRCLE_TAG $DOCKERHUB_REPO:$CIRCLE_TAG-amd64 --os linux --arch amd64
              sudo docker manifest annotate $DOCKERHUB_REPO:$CIRCLE_TAG $DOCKERHUB_REPO:$CIRCLE_TAG-i386 --os linux --arch 386
              sudo docker manifest annotate $DOCKERHUB_REPO:$CIRCLE_TAG $DOCKERHUB_REPO:$CIRCLE_TAG-arm --os linux --arch arm --variant v6
              sudo docker manifest annotate $DOCKERHUB_REPO:$CIRCLE_TAG $DOCKERHUB_REPO:$CIRCLE_TAG-arm32v7 --os linux --arch arm --variant v7
              sudo docker manifest annotate $DOCKERHUB_REPO:$CIRCLE_TAG $DOCKERHUB_REPO:$CIRCLE_TAG-arm64v8 --os linux --arch arm64 --variant v8
              sudo docker manifest push $DOCKERHUB_REPO:$CIRCLE_TAG -p
              sudo docker manifest create --amend $DOCKERHUB_REPO:$MAJOR_VERSION $DOCKERHUB_REPO:$MAJOR_VERSION-amd64 $DOCKERHUB_REPO:$MAJOR_VERSION-i386 $DOCKERHUB_REPO:$MAJOR_VERSION-arm $DOCKERHUB_REPO:$MAJOR_VERSION-arm32v7 $DOCKERHUB_REPO:$MAJOR_VERSION-arm64v8
              sudo docker manifest annotate $DOCKERHUB_REPO:$MAJOR_VERSION $DOCKERHUB_REPO:$MAJOR_VERSION-amd64 --os linux --arch amd64
              sudo docker manifest annotate $DOCKERHUB_REPO:$MAJOR_VERSION $DOCKERHUB_REPO:$MAJOR_VERSION-i386 --os linux --arch 386
              sudo docker manifest annotate $DOCKERHUB_REPO:$MAJOR_VERSION $DOCKERHUB_REPO:$MAJOR_VERSION-arm --os linux --arch arm --variant v6
              sudo docker manifest annotate $DOCKERHUB_REPO:$MAJOR_VERSION $DOCKERHUB_REPO:$MAJOR_VERSION-arm32v7 --os linux --arch arm --variant v7
              sudo docker manifest annotate $DOCKERHUB_REPO:$MAJOR_VERSION $DOCKERHUB_REPO:$MAJOR_VERSION-arm64v8 --os linux --arch arm64 --variant v8
              sudo docker manifest push $DOCKERHUB_REPO:$MAJOR_VERSION -p
              sudo docker manifest create --amend $DOCKERHUB_REPO:latest $DOCKERHUB_REPO:latest-amd64 $DOCKERHUB_REPO:latest-i386 $DOCKERHUB_REPO:latest-arm $DOCKERHUB_REPO:latest-arm32v7 $DOCKERHUB_REPO:latest-arm64v8
              sudo docker manifest annotate $DOCKERHUB_REPO:latest $DOCKERHUB_REPO:latest-amd64 --os linux --arch amd64
              sudo docker manifest annotate $DOCKERHUB_REPO:latest $DOCKERHUB_REPO:latest-i386 --os linux --arch 386
              sudo docker manifest annotate $DOCKERHUB_REPO:latest $DOCKERHUB_REPO:latest-arm --os linux --arch arm --variant v6
              sudo docker manifest annotate $DOCKERHUB_REPO:latest $DOCKERHUB_REPO:latest-arm32v7 --os linux --arch arm --variant v7
              sudo docker manifest annotate $DOCKERHUB_REPO:latest $DOCKERHUB_REPO:latest-arm64v8 --os linux --arch arm64 --variant v8
              sudo docker manifest push $DOCKERHUB_REPO:latest -p
            else if [[ $CIRCLE_BRANCH = master ]];
            then
              sudo docker manifest create --amend $DOCKERHUB_REPO:dev $DOCKERHUB_REPO:dev-amd64 $DOCKERHUB_REPO:dev-i386 $DOCKERHUB_REPO:dev-arm $DOCKERHUB_REPO:dev-arm32v7 $DOCKERHUB_REPO:dev-arm64v8
              sudo docker manifest annotate $DOCKERHUB_REPO:dev $DOCKERHUB_REPO:dev-amd64 --os linux --arch amd64
              sudo docker manifest annotate $DOCKERHUB_REPO:dev $DOCKERHUB_REPO:dev-i386 --os linux --arch 386
              sudo docker manifest annotate $DOCKERHUB_REPO:dev $DOCKERHUB_REPO:dev-arm --os linux --arch arm --variant v6
              sudo docker manifest annotate $DOCKERHUB_REPO:dev $DOCKERHUB_REPO:dev-arm32v7 --os linux --arch arm --variant v7
              sudo docker manifest annotate $DOCKERHUB_REPO:dev $DOCKERHUB_REPO:dev-arm64v8 --os linux --arch arm64 --variant v8
              sudo docker manifest push $DOCKERHUB_REPO:dev -p
            fi

  build-armhf:
    <<: *shared
    environment:
      QEMU_ARCH: arm
      TAG: arm
      TARGET: arm32v6
  build-amd64:
    <<: *shared
    environment:
      QEMU_ARCH: amd64
      TAG: amd64
      TARGET: amd64
  build-i386:
    <<: *shared
    environment:
      QEMU_ARCH: i386
      TAG: i386
      TARGET: i386
  build-arm64v8:
    <<: *shared
    environment:
      QEMU_ARCH: aarch64
      TAG: arm64v8
      TARGET: arm64v8
  build-arm32v7:
    <<: *shared
    environment:
      QEMU_ARCH: arm
      TAG: arm32v7
      TARGET: arm32v7

workflows:
  version: 2
  build_and_test:
    jobs:
      - test-server
      - test-front
      - build-front:
          requires:
            - test-server
            - test-front
          filters:
            tags:
              only: /^v\d+.\d+.\d+$/
            branches:
              only: master
      - build-armhf:
          requires:
            - build-front
          filters:
            tags:
              only: /^v\d+.\d+.\d+$/
            branches:
              only: master
      - build-amd64:
          requires:
            - build-front
          filters:
            tags:
              only: /^v\d+.\d+.\d+$/
            branches:
              only: master
      - build-i386:
          requires:
            - build-front
          filters:
            tags:
              only: /^v\d+.\d+.\d+$/
            branches:
              only: master
      - build-arm64v8:
          requires:
            - build-front
          filters:
            tags:
              only: /^v\d+.\d+.\d+$/
            branches:
              only: master
      - build-arm32v7:
          requires:
            - build-front
          filters:
            tags:
              only: /^v\d+.\d+.\d+$/
            branches:
              only: master
      - docker_manifest:
          requires:
            - build-amd64
            - build-arm64v8
            - build-i386
            - build-armhf
            - build-arm32v7
          filters:
            tags:
              only: /^v\d+.\d+.\d+$/
            branches:
              only: master
