name: Build Gladys dev images

on:
    workflow_dispatch:

jobs:
  build-front:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Setup nodejs
        uses: actions/setup-node@v1
        with:
            node-version: 12.x
      - run: cd front && npm install && npm run build
      - name: Upload build artifact
        uses: actions/upload-artifact@v1
        with:
          name: static
          path: front/build
  docker:
    needs: build-front
    name: Build and Push Gladys dev images
    runs-on: ubuntu-latest
    env:
      DOCKERHUB_USER:  ${{secrets.DOCKERHUB_USER}}
      DOCKERHUB_PASSWORD: ${{secrets.DOCKERHUB_PASSWORD}}
      DOCKERHUB_REPO: ${{secrets.DOCKERHUB_REPO}}
    steps:
    - 
      name: Checkout code
      uses: actions/checkout@v2
    -
      name: Set up QEMU
      uses: docker/setup-qemu-action@v1
    -
      name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v1
      with:
        version: latest 
    - 
      name: Download build artifact
      uses: actions/download-artifact@v1
      with:
        name: static
    - 
      name: Login to DockerHub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USER }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}
    -
      name: Build and push
      uses: docker/build-push-action@v2
      with:
        context: .
        file: ./docker/Dockerfile.buildx
        platforms: linux/amd64,linux/arm/v6,linux/arm/v7,linux/arm64
        push: true
        pull: true
        tags: |
            ${{ env.DOCKERHUB_REPO }}:dev
        cache-from: type=registry,ref=${{ env.DOCKERHUB_REPO }}:dev
        cache-to: type=inline
